---

title: curator

keywords: fastai
sidebar: home_sidebar

summary: "API details will follow"
description: "API details will follow"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Problem-Definition">Problem Definition<a class="anchor-link" href="#Problem-Definition"> </a></h2><p>Our goal is to curate a subset from a general pool of samples, that will satisfy a list of conditions as close as possible.</p>
<p>The pool of samples is given in a dataframe, which we'll call <em>df_samples</em>, it has one row per sample, and the columns represent all sort of meta data and features of the samples.</p>
<p>Let's see an example:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Load dataframe from file.</span>
<span class="n">df_samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;csvs/curation_pool.csv&#39;</span><span class="p">,</span> 
                         <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;birad&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">})</span>
<span class="n">df_samples</span> <span class="o">=</span> <span class="n">df_samples</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;study_id&#39;</span><span class="p">)</span>
<span class="n">df_samples</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>exists</th>
      <th>data_source</th>
      <th>age</th>
      <th>density</th>
      <th>birad</th>
      <th>lesion_type</th>
      <th>largest_mass</th>
      <th>is_pos</th>
    </tr>
    <tr>
      <th>study_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>optimam</td>
      <td>56</td>
      <td>2</td>
      <td>0</td>
      <td>calcification</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>optimam</td>
      <td>70</td>
      <td>4</td>
      <td>0</td>
      <td>mass</td>
      <td>16.87</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>optimam</td>
      <td>70</td>
      <td>2</td>
      <td>0</td>
      <td>mass</td>
      <td>10.15</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>optimam</td>
      <td>66</td>
      <td>2</td>
      <td>0</td>
      <td>mass</td>
      <td>10.71</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>imh</td>
      <td>49</td>
      <td>3</td>
      <td>0</td>
      <td>distortion</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>optimam</td>
      <td>67</td>
      <td>2</td>
      <td>0</td>
      <td>mass</td>
      <td>9.24</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>optimam</td>
      <td>47</td>
      <td>4</td>
      <td>0</td>
      <td>mass</td>
      <td>14.35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>optimam</td>
      <td>51</td>
      <td>3</td>
      <td>0</td>
      <td>calcification</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>optimam</td>
      <td>50</td>
      <td>4</td>
      <td>0</td>
      <td>calcification</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>optimam</td>
      <td>59</td>
      <td>3</td>
      <td>0</td>
      <td>calcification</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The conditions are given in a second dataframe, <em>df_cond_abs</em>. 
Each row of <em>df_cond_abs</em> is indexed by a <em>query</em> that can be applied to the df_samples (i.e. by using df_samples.query(query_string)). For each query the user specifies constraints supplied, regarding how many samples in the curated subset should satisfy the query. The constraints are given as a lower-bound and upper bound, as well as the penalty per violation (by default 1 if column not supplied). Ignore the <em>index_ref</em> column for now.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Get absolute numbers constraints </span>
<span class="n">df_cond_abs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;csvs/curation_conditions_abs.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
<span class="n">df_cond_abs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>index_ref</th>
    </tr>
    <tr>
      <th>query</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>is_pos == "1"</th>
      <td>400</td>
      <td>400</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>is_pos == "0"</th>
      <td>400</td>
      <td>400</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "0"</th>
      <td>160</td>
      <td>240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "0"</th>
      <td>160</td>
      <td>240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "1"</th>
      <td>160</td>
      <td>240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "1"</th>
      <td>160</td>
      <td>240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; is_pos == "1"</th>
      <td>270</td>
      <td>300</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>lesion_type == "calcification" &amp; is_pos == "1"</th>
      <td>110</td>
      <td>140</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>birad == "1" &amp; is_pos == "0"</th>
      <td>300</td>
      <td>320</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>birad == "2" &amp; is_pos == "0"</th>
      <td>80</td>
      <td>100</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&lt;=10</th>
      <td>30</td>
      <td>40</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20</th>
      <td>140</td>
      <td>180</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50</th>
      <td>75</td>
      <td>110</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>age&lt;50</th>
      <td>200</td>
      <td>240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>age&lt;60 &amp; age&gt;=50</th>
      <td>216</td>
      <td>264</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>age&lt;70 &amp; age&gt;=60</th>
      <td>176</td>
      <td>208</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>age&gt;=70</th>
      <td>120</td>
      <td>160</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By applying the queries on the <em>df_samples</em> dataframe, we obtain df_bool, a boolean dataframe which has the samples as rows and the queries as columns. <em>df_bool</em> indicates which sample matches which query.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_query_features_df" class="doc_header"><code>get_query_features_df</code><a href="https://github.com/jonilaserson/curation_magic/tree/master/curation_magic/curator.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_query_features_df</code>(<strong><code>df_samples</code></strong>, <strong><code>queries</code></strong>)</p>
</blockquote>
<p>Apply queries on df_samples and return a boolean feature dataframe.</p>
<p>If X = df_bool.values, then X[i, j] is True iff condition j is true for sample i</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_bool</span> <span class="o">=</span> <span class="n">get_query_features_df</span><span class="p">(</span><span class="n">df_samples</span><span class="p">,</span> <span class="n">df_cond_abs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">df_bool</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_pos == "1"</th>
      <th>is_pos == "0"</th>
      <th>data_source == "optimam" &amp; is_pos == "0"</th>
      <th>data_source == "imh" &amp; is_pos == "0"</th>
      <th>data_source == "optimam" &amp; is_pos == "1"</th>
      <th>data_source == "imh" &amp; is_pos == "1"</th>
      <th>lesion_type == "mass" &amp; is_pos == "1"</th>
      <th>lesion_type == "calcification" &amp; is_pos == "1"</th>
      <th>birad == "1" &amp; is_pos == "0"</th>
      <th>birad == "2" &amp; is_pos == "0"</th>
      <th>lesion_type == "mass" &amp; largest_mass&lt;=10</th>
      <th>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20</th>
      <th>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50</th>
      <th>age&lt;50</th>
      <th>age&lt;60 &amp; age&gt;=50</th>
      <th>age&lt;70 &amp; age&gt;=60</th>
      <th>age&gt;=70</th>
    </tr>
    <tr>
      <th>study_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can use this table to quickly see how many samples in our pool satisfy each query:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>is_pos == &#34;1&#34;                                                 811
is_pos == &#34;0&#34;                                                 655
data_source == &#34;optimam&#34; &amp; is_pos == &#34;0&#34;                      301
data_source == &#34;imh&#34; &amp; is_pos == &#34;0&#34;                          354
data_source == &#34;optimam&#34; &amp; is_pos == &#34;1&#34;                      653
data_source == &#34;imh&#34; &amp; is_pos == &#34;1&#34;                          158
lesion_type == &#34;mass&#34; &amp; is_pos == &#34;1&#34;                         556
lesion_type == &#34;calcification&#34; &amp; is_pos == &#34;1&#34;                188
birad == &#34;1&#34; &amp; is_pos == &#34;0&#34;                                  399
birad == &#34;2&#34; &amp; is_pos == &#34;0&#34;                                  195
lesion_type == &#34;mass&#34; &amp; largest_mass&lt;=10                       58
lesion_type == &#34;mass&#34; &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20    310
lesion_type == &#34;mass&#34; &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50    178
age&lt;50                                                        256
age&lt;60 &amp; age&gt;=50                                              489
age&lt;70 &amp; age&gt;=60                                              520
age&gt;=70                                                       201
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Basic-definition,-an-Integer-Program">Basic definition, an Integer Program<a class="anchor-link" href="#Basic-definition,-an-Integer-Program"> </a></h2><p>Here we assume we have the boundaries given as absolute numbers
($a_i$=lower_bound, $b_i$=upper_bound per query $i$). 
This means we want to have at least $a_i$ samples and at most $b_i$ samples that will satisfy query number $i$.</p>
<p>Let $x_1, x_2, \ldots, x_M$ be our indications, which samples are included in the final set. Hence, $x_j = 1$ if sample $j$ is included in the final set, otherwise it is 0.</p>
<p>Let $A$ be a $MxN$ binary array such that $A_{ji} = 1$ if and only if query $i$ is true for sample $j$.
Therefore we have $N$ queries and $M$ samples.</p>
<p>The integer program representing this problem is:
$$
\begin{array}{lrcl}
\min &amp;&amp;&amp; 1 \\
\text{s.t.}\hspace{0.5in}&amp;&amp;&amp;&amp;\\
&amp;a_i &amp;\leq&amp; \left(\sum_{j: A_{ji}=1} x_j \right) \leq b_i  &amp; \text{(for each query $i$)}\\
&amp;&amp;&amp;x_j \in \{0, 1\}&amp; \text{(for each sample $j$)}\\
\end{array}
$$</p>
<p>Notice:</p>
<ol>
<li>This is an <em>integer</em> program, because the $x_j$'s are constrained to be integers.</li>
<li>There's no target function to optimize, we just need to find a feasible solution for the $x_j$'s.</li>
<li>We can actually rewrite the first constraint to be $ a \leq Ax \leq b$.</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cond</span> <span class="o">=</span> <span class="n">df_cond_abs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cond</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">999</span>
<span class="n">df_cond</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>query
data_source == &#34;imh&#34; &amp; is_pos == &#34;0&#34;    999
Name: max, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Curator" class="doc_header"><code>class</code> <code>Curator</code><a href="https://github.com/jonilaserson/curation_magic/tree/master/curation_magic/curator.py#L34" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Curator</code>(<strong><code>df</code></strong>, <strong><code>df_cond</code></strong>, <strong><code>dedup</code></strong>=<em><code>True</code></em>, <strong><code>allow_violations</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="De-duplication">De-duplication<a class="anchor-link" href="#De-duplication"> </a></h3><p>By default, we're also using de-duping: In many cases samples would have identical feature vectors. Hence in such cases we collapse every <em>group</em> $j$ of samples with identical feature rows to a single row, and we denote by $m_j$ the number of samples in the group. However, this has an effect on the linear progam, since now every $x_j$ indicates the fraction of samples from the <em>group</em> $j$ that is going to be included in the curated set.</p>
<p>Hence, We need to replace every occurence of $$\left(\sum_{j: A_{ji}=1} x_j \right)$$ with $$\left(\sum_{j: A_{ji}=1} m_j x_j \right)$$</p>
<p>Alternatively we can multiply each row $j$ of $A$ by $m_j$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Decoding-the-Solution">Decoding the Solution<a class="anchor-link" href="#Decoding-the-Solution"> </a></h3><p>The solution lies in the values given to the $x_j$ variables by the linear solver. However, these values could be anything between 0 and 1. If we did not use de-duping, the simplest way to decide if a sample is included is to round each $x_j$ to the nearest integer, thus obtaining a boolean value (0 or 1).</p>
<p>If we did use de-duping, then each $x_j$ represent the <em>fraction</em> of samples from <em>group</em> $j$ that should be included. Hence we need to do two things in order to decide which individual samples to include:</p>
<ol>
<li>Set $n_j = \mbox{round}(x_j \cdot m_j)$, the number of group members to include.
For example, if $x_j=0.7$ and $m_j$=4, then $n_j=3$.</li>
<li>Randomly choose $n_j$ members from the total $m_j$ members of group $j$.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="AbsBoundariesCurator:-Relaxing-to-linear-progam">AbsBoundariesCurator: Relaxing to linear progam<a class="anchor-link" href="#AbsBoundariesCurator:-Relaxing-to-linear-progam"> </a></h2><p>To turn this into a <em>linear</em> program, we need to perform a few relaxations.
First, we will let our $x_j$'s become real numbers between 0 and 1 (we'll round them up or down later).
Second, we introduce auxiliary variables, $c_i$'s, one per query, that will measure the <em>violation</em> of each query.
Now our goal is to minimize the total number of violations, $c_1 + c_2 + ... + c_N$.</p>
<p>Of course, not all violations are created equal, the user might want to enforce a stronger penalty for violating some conditions over others.  If the user provides the penalty for violating for each constraint, our target method becomes $p_1c_1 + p_2c_2 + ... + p_Nc_N$, where $p_i$ is the penalty-per-violation of query $i$.</p>
<p>Our <em>linear</em> progam now looks like this:
$$
\begin{array}{lrcl}
\min &amp;&amp;&amp;p_1c_1 + p_2c_2 + ... + p_Nc_N \\
\text{s.t.}\hspace{0.5in}&amp;&amp;&amp;&amp;\\
&amp;a_i - c_i &amp;\leq&amp; \left(\sum_{j: A_{ji}=1} x_j \right) \leq b_i + c_i &amp; \text{(for each query $i$)}\\
&amp;0 &amp;\leq&amp; x_j \leq 1&amp; \text{(for each sample $j$)}\\
&amp;0 &amp;\leq&amp; c_i &amp; \text{(for each query $i$)}
\end{array}
$$</p>
<p>Notice that in the first constraint can be broken into two constraints:
$$
\begin{array}{rl}
a_i \leq &amp;\left(\sum_{j: A_{ji}=1} x_j \right) + c_i&amp;\\
         &amp;\left(\sum_{j: A_{ji}=1} x_j \right) - c_i &amp;\leq b_i
\end{array}
$$
one of them is always true, and as we increase $c_i$ from 0, at some point the other condition also becomes true.</p>
<p>We can also re-write these constraints as upper-bound constrains, and in vector form:
$$
\begin{array}{rll}
Ax - c &amp;\leq&amp; b\\
-Ax -c &amp;\leq&amp; -a
\end{array}
$$</p>
<p>This is the problem that the class <em>AbsBoundariesCurator</em> defines.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AbsBoundariesCurator" class="doc_header"><code>class</code> <code>AbsBoundariesCurator</code><a href="https://github.com/jonilaserson/curation_magic/tree/master/curation_magic/curator.py#L166" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AbsBoundariesCurator</code>(<strong><code>df</code></strong>, <strong><code>df_cond</code></strong>, <strong><code>dedup</code></strong>=<em><code>True</code></em>, <strong><code>allow_violations</code></strong>=<em><code>True</code></em>) :: <a href="/curation_magic/core#Curator"><code>Curator</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's use the <em>AbsBoundariesCurator</em> to find a curated set:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cc</span> <span class="o">=</span> <span class="n">AbsBoundariesCurator</span><span class="p">(</span><span class="n">df_samples</span><span class="p">,</span> <span class="n">df_cond_abs</span><span class="p">)</span>

<span class="c1"># Note, we are using here the interior-point solver which is</span>
<span class="c1"># faster but less accurate than the default simplex solver.</span>
<span class="n">included</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;interior-point&#39;</span><span class="p">)</span>

<span class="c1"># Let&#39;s sanity-check that we obtained a reasonable solution.</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">included</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">780</span><span class="p">)</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">included</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">820</span><span class="p">)</span>

<span class="c1"># The summary shows how many were included from every query,</span>
<span class="c1"># and the total number of violations.</span>
<span class="n">summary</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Theoretical penalty: 4.000000001349921
Actual penalty: 5   Total violations: 5
Included: 799
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cnt</th>
      <th>min</th>
      <th>max</th>
      <th>total</th>
      <th>violation</th>
    </tr>
    <tr>
      <th>query</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>is_pos == "1"</th>
      <td>399</td>
      <td>400</td>
      <td>400</td>
      <td>811</td>
      <td>1</td>
    </tr>
    <tr>
      <th>is_pos == "0"</th>
      <td>400</td>
      <td>400</td>
      <td>400</td>
      <td>655</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "0"</th>
      <td>161</td>
      <td>160</td>
      <td>240</td>
      <td>301</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "0"</th>
      <td>239</td>
      <td>160</td>
      <td>240</td>
      <td>354</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "1"</th>
      <td>241</td>
      <td>160</td>
      <td>240</td>
      <td>653</td>
      <td>1</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "1"</th>
      <td>158</td>
      <td>160</td>
      <td>240</td>
      <td>158</td>
      <td>2</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; is_pos == "1"</th>
      <td>269</td>
      <td>270</td>
      <td>300</td>
      <td>556</td>
      <td>1</td>
    </tr>
    <tr>
      <th>lesion_type == "calcification" &amp; is_pos == "1"</th>
      <td>111</td>
      <td>110</td>
      <td>140</td>
      <td>188</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "1" &amp; is_pos == "0"</th>
      <td>303</td>
      <td>300</td>
      <td>320</td>
      <td>399</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "2" &amp; is_pos == "0"</th>
      <td>85</td>
      <td>80</td>
      <td>100</td>
      <td>195</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&lt;=10</th>
      <td>34</td>
      <td>30</td>
      <td>40</td>
      <td>58</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20</th>
      <td>147</td>
      <td>140</td>
      <td>180</td>
      <td>310</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50</th>
      <td>84</td>
      <td>75</td>
      <td>110</td>
      <td>178</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;50</th>
      <td>212</td>
      <td>200</td>
      <td>240</td>
      <td>256</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;60 &amp; age&gt;=50</th>
      <td>249</td>
      <td>216</td>
      <td>264</td>
      <td>489</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;70 &amp; age&gt;=60</th>
      <td>198</td>
      <td>176</td>
      <td>208</td>
      <td>520</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&gt;=70</th>
      <td>140</td>
      <td>120</td>
      <td>160</td>
      <td>201</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As you can see above, the linear solver had 4 violations, but after we decoded the solution (round the $x_j$ values and decide which samples to include), there were 5 violations in total. The optimal LP target value is always going to be a lower bound on the <em>integer</em> progam target.</p>
<p>Our curated set has 799 members instead of 800, specifically one extra positive. Also, we have one extra positive study from optimam, and 2 too few studies from imh.  In addition, we are missing one positive study of type 'mass'.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's say the this latter constraint about positive masses is more important than others. We <em>really</em> want this constraint to be satisfied.  We can tweak the optimization by giving a larger penalty for each violation of this constraint.  Say 5 penalty points vs. only 1 penalty for the other conditions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cond_abs</span><span class="p">[</span><span class="s1">&#39;penalty_per_violation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">df_cond_abs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;lesion_type == &quot;mass&quot; &amp; is_pos == &quot;1&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;penalty_per_violation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">cc</span> <span class="o">=</span> <span class="n">AbsBoundariesCurator</span><span class="p">(</span><span class="n">df_samples</span><span class="p">,</span> <span class="n">df_cond_abs</span><span class="p">)</span>
<span class="n">included</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;interior-point&#39;</span><span class="p">)</span>

<span class="n">summary</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Theoretical penalty: 3.9999999974722984
Actual penalty: 5   Total violations: 5
Included: 801
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cnt</th>
      <th>min</th>
      <th>max</th>
      <th>total</th>
      <th>violation</th>
    </tr>
    <tr>
      <th>query</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>is_pos == "1"</th>
      <td>400</td>
      <td>400</td>
      <td>400</td>
      <td>811</td>
      <td>0</td>
    </tr>
    <tr>
      <th>is_pos == "0"</th>
      <td>401</td>
      <td>400</td>
      <td>400</td>
      <td>655</td>
      <td>1</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "0"</th>
      <td>163</td>
      <td>160</td>
      <td>240</td>
      <td>301</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "0"</th>
      <td>238</td>
      <td>160</td>
      <td>240</td>
      <td>354</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "1"</th>
      <td>242</td>
      <td>160</td>
      <td>240</td>
      <td>653</td>
      <td>2</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "1"</th>
      <td>158</td>
      <td>160</td>
      <td>240</td>
      <td>158</td>
      <td>2</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; is_pos == "1"</th>
      <td>270</td>
      <td>270</td>
      <td>300</td>
      <td>556</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "calcification" &amp; is_pos == "1"</th>
      <td>111</td>
      <td>110</td>
      <td>140</td>
      <td>188</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "1" &amp; is_pos == "0"</th>
      <td>304</td>
      <td>300</td>
      <td>320</td>
      <td>399</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "2" &amp; is_pos == "0"</th>
      <td>85</td>
      <td>80</td>
      <td>100</td>
      <td>195</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&lt;=10</th>
      <td>34</td>
      <td>30</td>
      <td>40</td>
      <td>58</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20</th>
      <td>147</td>
      <td>140</td>
      <td>180</td>
      <td>310</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50</th>
      <td>84</td>
      <td>75</td>
      <td>110</td>
      <td>178</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;50</th>
      <td>212</td>
      <td>200</td>
      <td>240</td>
      <td>256</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;60 &amp; age&gt;=50</th>
      <td>250</td>
      <td>216</td>
      <td>264</td>
      <td>489</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;70 &amp; age&gt;=60</th>
      <td>199</td>
      <td>176</td>
      <td>208</td>
      <td>520</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&gt;=70</th>
      <td>140</td>
      <td>120</td>
      <td>160</td>
      <td>201</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Goodie!  We still have 5 violations but now that positive-mass constraint is satisfied! (and we curated 801 samples instead of 800).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can go back to the original samples dataframe, and add a new column indicating which samples would participate in the final set:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_samples</span><span class="p">[</span><span class="s1">&#39;included&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">included</span>
<span class="n">df_samples</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>exists</th>
      <th>data_source</th>
      <th>age</th>
      <th>density</th>
      <th>birad</th>
      <th>lesion_type</th>
      <th>largest_mass</th>
      <th>is_pos</th>
      <th>included</th>
    </tr>
    <tr>
      <th>study_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>optimam</td>
      <td>56</td>
      <td>2</td>
      <td>0</td>
      <td>calcification</td>
      <td>NaN</td>
      <td>1</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>optimam</td>
      <td>70</td>
      <td>4</td>
      <td>0</td>
      <td>mass</td>
      <td>16.87</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>optimam</td>
      <td>70</td>
      <td>2</td>
      <td>0</td>
      <td>mass</td>
      <td>10.15</td>
      <td>1</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>optimam</td>
      <td>66</td>
      <td>2</td>
      <td>0</td>
      <td>mass</td>
      <td>10.71</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>imh</td>
      <td>49</td>
      <td>3</td>
      <td>0</td>
      <td>distortion</td>
      <td>NaN</td>
      <td>1</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Relative-bounds-for-the-constraints">Using Relative bounds for the constraints<a class="anchor-link" href="#Using-Relative-bounds-for-the-constraints"> </a></h2><p>The fact that the condition boundaties are given in absolute integer numbers is actually a limitation:
Say we are willing to have some flexibility with regard to the number of negatives we curate (i.e. anything in the range 350-450 is fine), but within the chosen set of negatives, we would like 25% to be with birad=2. Since we don't know how many negatives we'll turn up with, there is no way to put a tight bound (in absolute numbers) on the number of birad=2 samples.</p>
<p>What we want is to be able to bound a query relative to the (yet unknown) number of samples that satisfy a previous query.  So an alternative way to provide boundaries is in the form of a <em>fraction</em> relative to the resulting set satisfying a different query.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Get relative fraction constraints</span>
<span class="n">df_cond_rel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;csvs/curation_conditions_rel.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
<span class="n">df_cond_rel</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>query</th>
      <th>min</th>
      <th>max</th>
      <th>index_ref</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>exists == "1"</td>
      <td>800.00</td>
      <td>800.00</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>is_pos == "1"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>is_pos == "0"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>data_source == "optimam" &amp; is_pos == "0"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>data_source == "imh" &amp; is_pos == "0"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>data_source == "optimam" &amp; is_pos == "1"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>data_source == "imh" &amp; is_pos == "1"</td>
      <td>0.40</td>
      <td>0.60</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>lesion_type == "mass" &amp; is_pos == "1"</td>
      <td>0.65</td>
      <td>0.70</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>lesion_type == "calcification" &amp; is_pos == "1"</td>
      <td>0.30</td>
      <td>0.35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>birad == "1" &amp; is_pos == "0"</td>
      <td>0.75</td>
      <td>0.80</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10</th>
      <td>birad == "2" &amp; is_pos == "0"</td>
      <td>0.20</td>
      <td>0.25</td>
      <td>2</td>
    </tr>
    <tr>
      <th>11</th>
      <td>lesion_type == "mass" &amp; largest_mass&lt;=10</td>
      <td>0.10</td>
      <td>0.15</td>
      <td>7</td>
    </tr>
    <tr>
      <th>12</th>
      <td>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; larg...</td>
      <td>0.50</td>
      <td>0.60</td>
      <td>7</td>
    </tr>
    <tr>
      <th>13</th>
      <td>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; larg...</td>
      <td>0.25</td>
      <td>0.30</td>
      <td>7</td>
    </tr>
    <tr>
      <th>14</th>
      <td>age&lt;50</td>
      <td>0.25</td>
      <td>0.30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>age&lt;60 &amp; age&gt;=50</td>
      <td>0.27</td>
      <td>0.33</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>age&lt;70 &amp; age&gt;=60</td>
      <td>0.22</td>
      <td>0.26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>age&gt;=70</td>
      <td>0.15</td>
      <td>0.20</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, in line 10, we ask that the number of samples satisfying the query [<em>birad == "2" &amp; is_pos == "0"</em>] would be at least 20% and no more than 25% of the samples satisfying query 2 [<em>is_pos == "0"</em>], as indicated by the column <em>index_ref</em>. This is how we were able to define a condition relevant to the negative set without knowing how many negative we'll have at the end!</p>
<p>We still have to ground the solution in some absolute number of desired sample, so we used integer boundaries for the first query above, simply by setting <em>index_ref=-1</em> (otherwise the solution is not well defined and the LP solver might not converge).</p>
<p>Now how can we incorporate those constraints in a linear program?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="RelBoundariesCurator:">RelBoundariesCurator:<a class="anchor-link" href="#RelBoundariesCurator:"> </a></h3><p>So we need a new LP, and now we assume that each query $i$ has 3 values: $(a_i=\mbox{lower bound}, b_i=\mbox{upper bound}, k_i)$, where $k_i &lt; i$.  BUT here the upper and lower bounds are <em>given as fractions</em> of the number of elements satisfying query $k_i$.</p>
<p>To simplify notations, we add additional auxiliary variables, $y_i$'s, that just count how many samples are included that satisfy each query. Hence we "constrain" $y_i$ to be $\left(\sum_{j: A_{ji}=1} x_j \right)$, or in other words, define $y = Ax$.</p>
<p>So, if $k_i = -1$, then use $a_i$ and $b_i$ as before (boundaries in absolute numbers).</p>
<p>If $k_i \geq  0$, then the boundaries in absolute numbers are $(a_i \cdot y_{k_i}, b_i \cdot y_{k_i})$, where 
$y_{k_i}$ is the (yet unknown) number of elements satisfying query $k_i$ in the solution.</p>
<p>This allows having constraints like "At least half of the positives should be under 50" and still allow flexibility in the number of positives.</p>
<p>Out <em>linear</em> progam now looks like this (after conversion to upper-bound constraints):
$$
\begin{array}{lrcl}
\min &amp;&amp;&amp;p_1c_1 + p_2c_2 + ... + p_Nc_N \\
\text{s.t.}\hspace{0.5in}&amp;&amp;&amp;&amp;\\
&amp;y_i = \left(\sum_{j: A_{ji}=1} x_j \right) \\
&amp;y_i - c_i - b_i \cdot y_{k_i} &amp;\leq&amp; 0 &amp; \text{(for each query $i$)}\\
&amp;-y_i - c_i + a_i \cdot y_{k_i} &amp;\leq&amp; 0 &amp; \text{(for each query $i$)}\\
%&amp;a_i \cdot y_{k_i} - c_i &amp;\leq&amp; y_i \leq b_i \cdot y_{k_i} + c_i &amp; \text{(for each query $i$)}\\
&amp;0 &amp;\leq&amp; x_j \leq 1&amp; \text{(for each sample $j$)}\\
&amp;0 &amp;\leq&amp; c_i &amp; \text{(for each query $i$)}
\end{array}
$$</p>
<p>This is the problem that the class <em>RelBoundariesCurator</em> defines.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RelBoundariesCurator" class="doc_header"><code>class</code> <code>RelBoundariesCurator</code><a href="https://github.com/jonilaserson/curation_magic/tree/master/curation_magic/curator.py#L195" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RelBoundariesCurator</code>(<strong><code>df</code></strong>, <strong><code>df_cond</code></strong>, <strong><code>dedup</code></strong>=<em><code>True</code></em>, <strong><code>allow_violations</code></strong>=<em><code>True</code></em>) :: <a href="/curation_magic/core#Curator"><code>Curator</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's run the <em>RelBoundariesCurator</em> to solve this (here with the simplex method):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cc</span> <span class="o">=</span> <span class="n">RelBoundariesCurator</span><span class="p">(</span><span class="n">df_samples</span><span class="p">,</span> <span class="n">df_cond_rel</span><span class="p">)</span>
<span class="n">included</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Let&#39;s sanity-check that we obtained a reasonable solution.</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">included</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">780</span><span class="p">)</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">included</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">820</span><span class="p">)</span>
<span class="n">tc</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">violation</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">summary</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Theoretical penalty: 1.7763568394002505e-15
Actual penalty: 0   Total violations: 0
Included: 800
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cnt</th>
      <th>min</th>
      <th>max</th>
      <th>total</th>
      <th>violation</th>
    </tr>
    <tr>
      <th>query</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>exists == "1"</th>
      <td>800</td>
      <td>800</td>
      <td>800</td>
      <td>1466</td>
      <td>0</td>
    </tr>
    <tr>
      <th>is_pos == "1"</th>
      <td>395</td>
      <td>320</td>
      <td>480</td>
      <td>811</td>
      <td>0</td>
    </tr>
    <tr>
      <th>is_pos == "0"</th>
      <td>405</td>
      <td>320</td>
      <td>480</td>
      <td>655</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "0"</th>
      <td>184</td>
      <td>162</td>
      <td>243</td>
      <td>301</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "0"</th>
      <td>221</td>
      <td>162</td>
      <td>243</td>
      <td>354</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "optimam" &amp; is_pos == "1"</th>
      <td>237</td>
      <td>158</td>
      <td>237</td>
      <td>653</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data_source == "imh" &amp; is_pos == "1"</th>
      <td>158</td>
      <td>158</td>
      <td>237</td>
      <td>158</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; is_pos == "1"</th>
      <td>259</td>
      <td>257</td>
      <td>276</td>
      <td>556</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "calcification" &amp; is_pos == "1"</th>
      <td>119</td>
      <td>118</td>
      <td>138</td>
      <td>188</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "1" &amp; is_pos == "0"</th>
      <td>304</td>
      <td>304</td>
      <td>324</td>
      <td>399</td>
      <td>0</td>
    </tr>
    <tr>
      <th>birad == "2" &amp; is_pos == "0"</th>
      <td>81</td>
      <td>81</td>
      <td>101</td>
      <td>195</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&lt;=10</th>
      <td>29</td>
      <td>26</td>
      <td>39</td>
      <td>58</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;10 &amp; largest_mass&lt;=20</th>
      <td>155</td>
      <td>130</td>
      <td>155</td>
      <td>310</td>
      <td>0</td>
    </tr>
    <tr>
      <th>lesion_type == "mass" &amp; largest_mass&gt;20 &amp; largest_mass&lt;=50</th>
      <td>65</td>
      <td>65</td>
      <td>78</td>
      <td>178</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;50</th>
      <td>200</td>
      <td>200</td>
      <td>240</td>
      <td>256</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;60 &amp; age&gt;=50</th>
      <td>264</td>
      <td>216</td>
      <td>264</td>
      <td>489</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&lt;70 &amp; age&gt;=60</th>
      <td>176</td>
      <td>176</td>
      <td>208</td>
      <td>520</td>
      <td>0</td>
    </tr>
    <tr>
      <th>age&gt;=70</th>
      <td>160</td>
      <td>120</td>
      <td>160</td>
      <td>201</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And we reached an optimal solution!</p>

</div>
</div>
</div>
</div>
 

